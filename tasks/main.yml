---

- name: Configure domain for OpenLDAP in debconf: Strings
  debconf: name='slapd'
           question='{{ item.key }}'
           vtype='string'
           value='{{ item.value }}'
  with_dict:
    slapd/domain: '{{slapd_domain}}'
    shared/organization: '{{slapd_domain}}'
    slapd/backend: '{{slapd_backend|upper}}'

- name: Configure domain for OpenLDAP in debconf: Booleans
  debconf: name='slapd'
           question='{{ item.key }}'
           vtype='boolean'
           value='{{ item.value }}'
  with_dict:
    slapd/no_configuration: 'false'
    slapd/move_old_database: 'true'
    slapd/allow_ldap_v2: 'false'

- name: Configure domain for OpenLDAP in debconf: Passwords
  debconf: name='slapd'
           question='{{ item.key }}'
           vtype='password'
           value='{{ item.value }}'
  with_dict:
    slapd/password1: '{{slapd_password}}'
    slapd/password2: '{{slapd_password}}'

- name: Install OpenLDAP packages
  apt: name={{ item }}
  with_items:
  - slapd
  - ldap-utils
  - python-ldap
  - ldapvi

- name: host LDAP base
  lineinfile: dest=/etc/ldap/ldap.conf
              regexp='#?BASE'
              line='BASE   {{slapd_base}}'

- name: host LDAP uri
  lineinfile: dest=/etc/ldap/ldap.conf
              regexp='#?URI'
              line='URI    ldap://{{slapd_domain}}/'

- name: Configure LDAP ACLs
  ldap_attr:
        dn: 'olcDatabase={1}{{ slapd_backend }},cn=config'
        name: 'olcAccess'
        values: '{{lookup("template", "slapd_acl.jinja2")|from_yaml}}'
        state: 'exact'
  tags: debug

